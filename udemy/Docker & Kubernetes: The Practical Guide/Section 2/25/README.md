## 25. 이미지 레이어 이해하기

이미지를 빌드하면 Dockerfile에 있는 명령이 실행되고, 이미지가 닫힌다.
그렇기 떄문에 코드가 변경되어 새 코드를 새 이미지에 복사하려는 경우와 같이, 무언가를 업데이트해야 하는 경우 다시 빌드 해야한다. 

이처럼 이미지를 빌드하거나 이미지를 다시 빌드할 떄, 변경된 부분의 명령과 그 이후의 모든 명령이 reevaluate(재평가) 되는 것을 레이어 기반이라고 한다.

도커는 이미지를 빌드할 떄 마다 모든 명령 결과를 **캐싱**하기 떄문에 같은 명령어로 빌드를 여러번 할 경우, 동일한 이미지를 다시 빌드할 때 명령을 다시 실행할 필요가 없으면 캐싱된 결과를 사용한다. 모든 명령은 Dockerfile의 레이어를 나타낸다.

이를 **레이어 기반 아키텍처**라고 한다.

이미지는 이러한 다양한 명령을 기반으로 여러 레이어에서 간단하게 구성된다. 이미지는 읽기 전용이다.
즉 일단 명령이 실행되고, 이미지가 빌드되면 이미지가 잠기고, 이미지를 다시 빌드하지 않는 한 코드를 변경할 수 없다. 이는 기술적으로 새 이미지를 생성한다는 의미이다. 

하나의 레이어가 변경될 때마다 다른 모든 레이어가 다시 빌드된다. `npm install` 의 경우, 도커는 이전과 동일한 결과를 산출할지 여부를 알 수 없기 떄문에 캐싱과 상관없이 하나의 레이어가 변경될 때 마다 매번 다시 실행된다. (다시 실행해야 하는 항목만 다시 빌드하여 다시 실행하지만, `npm install`은 매번 다시 실행한다는 뜻같다.)

대신 기존 순서에서  `npm install` 전에 `package.json` 파일을 `/app` 에 복사한 다음에 `RUN npm install`을 하고 `COPY . /app` 을 하면 단순히 소스코드를 수정한 경우에는 `npm install` 이 다시 실행되지 않는다. (최적화)
-> 소스코드를 복사하기 전에 `npm install` 레이어가 오기 때문이다. 
```docker
FROM node

WORKDIR /app

COPY package.json /app

RUN npm install

COPY . /app # 소스코드만 변경될 경우, 이 앞의 레이어는 다시 실행되지 않는다. 

EXPOSE 80

CMD ["node", "server.js"]
```